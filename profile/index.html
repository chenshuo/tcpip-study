<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Profiling - Shuo's Linux TCP/IP notes</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
        <link href="../extra.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Profiling";
        var mkdocs_page_input_path = "profile.md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-1220141-6', 'chenshuo.com');
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> Shuo's Linux TCP/IP notes
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../sockets/">Sockets</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../throughput/">Throughput</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="./">Profiling</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#tx-path">Tx path</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#rx-path">Rx path</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#loopback-w-ipv6">Loopback w/ IPv6</a>
    </li>
    </ul>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../walkthrough/">Walkthrough</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../slowstart/">Slow Start</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../reno/">Reno CC</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../links/">Links</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">Shuo's Linux TCP/IP notes</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" alt="Docs"></a> &raquo;</li>
      <li>Profiling</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="profiling-linux-tcpip-stack-with-perf-and-pprof">Profiling Linux TCP/IP stack with perf and pprof</h1>
<p>At home, I have two Linux hosts with Mellanox 10GbE nic (ConnectX EN 10GigE MT26448, bought used from Ebay in 2017)
directly connected using SPF cable.</p>
<p><img alt="10gbe" src="../img/10gbe.jpg" /></p>
<p><img alt="10gbe" src="../img/direct-10gbe.png" /></p>
<p>Thoughput was about 1100MiB/s over 10GbE, both machine runs ~40% CPU utilization in one thread.</p>
<p>For comparison, run <code>openssl speed sha</code> on the Rx side machine, an i7-3770 @ 3.4GHz.</p>
<pre><code class="language-bash">$ openssl speed sha
OpenSSL 1.1.1f  31 Mar 2020
The 'numbers' are in 1000s of bytes per second processed.
type             16 bytes     64 bytes    256 bytes   1024 bytes   8192 bytes  16384 bytes
sha1            137355.08k   323943.17k   603290.54k   770941.95k   843352.75k   849619.63k
sha256           75659.30k   167113.02k   289437.70k   354737.49k   379652.78k   381676.20k
sha512           51745.33k   206941.63k   329443.07k   468301.82k   533897.22k   539525.12k
</code></pre>
<p>In short, sending data through TCP is faster than calculating SHA1 locally.</p>
<p>Rx is more expensive, it uses about 2x CPU cycles than Tx.</p>
<h2 id="tx-path">Tx path</h2>
<p>Profile taken on Debian bullseye (testing, pre-release 11) w/ kernel 5.6.14.
Run the <a href="https://github.com/chenshuo/recipes/blob/master/tpc/bin/chargen.cc">chargen</a> program
to keep sending data to a <code>discard</code> server.</p>
<p><a href="../img/profile-chargen.html"><img alt="chargen" src="../img/profile-chargen.png" /></a></p>
<h2 id="rx-path">Rx path</h2>
<p>Profile taken on Ubuntu 18.04 w/ kernel 4.15
Run the <a href="https://github.com/chenshuo/recipes/blob/master/tpc/bin/discard.cc">discard</a> program
to keep reading the socket.</p>
<p><a href="../img/profile-discard.html"><img alt="discard" src="../img/profile-discard.png" /></a></p>
<h2 id="loopback-w-ipv6">Loopback w/ IPv6</h2>
<p>Profile taken on Ubuntu 20.04 w/ kernel 5.4.
Run both <code>chargen</code> and <code>discard</code> on the same i7-3770 host,
throughput was about 3300MiB/s.  <code>chargen</code> ran at 100% CPU, <code>discard</code> was about 74%.</p>
<p><a href="../img/profile-loopback6.html"><img alt="loopback" src="../img/profile-loopback6.png" /></a></p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../throughput/" class="btn btn-neutral float-left" title="Throughput"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../walkthrough/" class="btn btn-neutral float-right" title="Walkthrough">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../throughput/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../walkthrough/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="https://cdn.jsdelivr.net/gh/rod2ik/cdn@main/mkdocs/javascripts/mkdocs-graphviz.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
